name: Build and Push Frontend

on:
  push:
    branches: [ main ]

env:
  REGISTRY: localhost:5000
  IMAGE_NAME: ticketboard-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Kind with Local Registry
        run: |
          # Crear cluster Kind con registry (igual que en backend)
          cat <<EOF | kind create cluster --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          containerdConfigPatches:
          - |-
            [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5000"]
              endpoint = ["http://kind-registry:5000"]
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
            - containerPort: 30000
              hostPort: 30000
              protocol: TCP
          EOF

          # Crear y conectar registry local
          docker run -d --restart=always -p 5000:5000 --name kind-registry registry:2
          docker network connect kind kind-registry || true

          # Verificar registry
          curl http://localhost:5000/v2/_catalog

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci

      - name: Build with Vite
        run: |
          VITE_API_URL=http://backend-service:8080 npm run build
          ls -la dist/

      - name: Build and push to local registry
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

          # Verificar que la imagen se subiÃ³
          curl http://localhost:5000/v2/_catalog
          curl http://localhost:5000/v2/${{ env.IMAGE_NAME }}/tags/list

      - name: Deploy to Kind cluster
        run: |
          # Crear namespace si no existe
          kubectl create namespace ticketboard --dry-run=client -o yaml | kubectl apply -f -

          # Aplicar los manifests del frontend
          cat > frontend-deployment.yaml << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: frontend-deployment
            namespace: ticketboard
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: frontend
            template:
              metadata:
                labels:
                  app: frontend
              spec:
                containers:
                - name: frontend
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                  ports:
                  - containerPort: 80
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: 80
                    initialDelaySeconds: 10
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /health
                      port: 80
                    initialDelaySeconds: 5
                    periodSeconds: 5
          EOF

          cat > frontend-service.yaml << 'EOF'
          apiVersion: v1
          kind: Service
          metadata:
            name: frontend-service
            namespace: ticketboard
          spec:
            selector:
              app: frontend
            ports:
            - port: 80
              targetPort: 80
            type: ClusterIP
          EOF

          # Aplicar o actualizar los recursos
          kubectl apply -f frontend-deployment.yaml
          kubectl apply -f frontend-service.yaml

          # Esperar a que el pod estÃ© listo
          kubectl rollout status deployment/frontend-deployment -n ticketboard --timeout=180s

          # Verificar el despliegue
          echo "ðŸ“Š Estado del despliegue:"
          kubectl get pods -n ticketboard -o wide
          kubectl get svc -n ticketboard

      - name: Test deployment
        run: |
          # Usar port-forward para probar la aplicaciÃ³n
          kubectl port-forward -n ticketboard svc/frontend-service 8080:80 &
          PORT_FORWARD_PID=$!
          sleep 10

          # Health check
          if curl -f http://localhost:8080/health; then
            echo "âœ… Frontend desplegado exitosamente"
          else
            echo "âŒ Health check fallÃ³"
            exit 1
          fi

          # Limpiar
          kill $PORT_FORWARD_PID

      - name: Cleanup (optional)
        if: always()
        run: |
          # Opcional: eliminar el cluster para ahorrar recursos
          # kind delete cluster
          echo "âœ… Pipeline completado"
